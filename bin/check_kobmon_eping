#!/bin/bash
# Author: Uwe Ebel (kobmaki, kobmaki @ aol.com)
# Version: 1.0
# Project: kobmon-check
# Url: https://github.com/kobmaki/kobmon-check
# Info: runs 5 ping packages in a short interval  200ms


unset LANG
CHECKNAME='EPING'
# Some default parameters
aHostIp=${aHostIp-localhost}
aPackageCount=${aPackageCount-5}
aPackageIntervall=${aPackageIntervall-0.2}
aAction='check'

# function for debug output
decho (){
    if [ "${DEBUG}" != "" ]; then
	echo $@
    fi
}

function output2pnp (){
    local aOutput=$1
    aReturn="PNP unavailable"
}

function showHelp(){
    # something
    cat <<EOF
usage check_kobmon_eping [-h] [-H <hostname>] [-i <intervall>] [-w <warning percent>] [-c <critical percent>]
 -h -- Show this help
 -H -- required hostname or ip
 -i -- intervall for the ping checks
 -w -- percent of package for a warning
 -c -- percent of package lost for a critical
EOF
}

# read options
while getopts "::h:H:i:C::g(ateway)::w::c:" Option
do
    case $Option in
	h)
	    decho "help"
	    aAction='help'
	    ;;
	H) decho "option H for host   [OPTIND=${OPTIND}]";
	   aHostIp=${OPTARG}
	   ;;
	w) aWarnPer=${OPTARG}
	   ;;
	c) aCritPer=${OPTARG}
	   ;;
	C) aPackageCount=${OPTARG}
	   decho "aPackageCount:"${aPackageCount}
	   ;;
	g) aGateway=${OPTARG}
	   ;;
	i) aPackageIntervall=${OPTARG}
	    ;;
	*) CRITICAL=${CRITICAL}", UNSUPPORTER PARAMETER "${Option}
	   ;;
    esac
done


function runCheck(){
aD=`ping -c ${aPackageCount} -w 9 -i ${aPackageIntervall} ${aHostIp} 2>&1`
aRet=$?
aOut="???"
aD=`echo ${aD} | sed s/".*--- "//g`

if [ ${aRet} -eq  1 ]; then
# ping returns 1 if host not found, unreachable, error packages
aRet=2;
fi

# OK, ping return 0, but maybe it contains error/duplicate package
if [ ${aRet} -eq 0 ]; then

 # have package loss   
 [[ ! ${aD} =~ ' 0% packet loss' ]] && aRet=1

 # have duplicate packages
 [[ ${aD} =~ ' duplicate' ]] && aRet=1

fi


case ${aRet} in
  0) aOut="OK ${aHostIp} - "${aD}
  ;;

  1) aOut="WARNING ${aHostIp} - "${aD}
    ;;
  
  2) aOut="CRITICAL ${aHostIp} - "${aD}
  
   ;;
  3) aOut="UNKNOWN ${aHostIp} - "${aD}
    ;;
  *) 
    aOut="??? ${aHostIp} - "${aD}
  ;;
esac
echo ${CHECKNAME}" "${aOut}
exit ${aRet}
}


case ${aAction} in
    help)
	showHelp
	;;
    check)
	runCheck
	;;
    *)

	;;
esac

